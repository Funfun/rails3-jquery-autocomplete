/*
* Unobtrusive autocomplete
*
* To use it, you just have to include the HTML attribute autocomplete
* with the autocomplete URL as the value
*
*   Example:
*       <input type="text" data-autocomplete="/url/to/autocomplete">
*
* Optionally, you can use a jQuery selector to specify a field that can
* be updated with the element id whenever you find a matching value
*
*   Example:
*       <input type="text" data-autocomplete="/url/to/autocomplete" data-id-element="#id_field">
*/
$(document).ready(function(){$("input[data-autocomplete]").railsAutocomplete()});(function(a){var b=0,c,d=0,e=-1,f=0,g=true,h="suggestions_for_";a.fn.railsAutocomplete=function(){return this.live("focus",function(){if(!this.railsAutoCompleter){this.railsAutoCompleter=new a.railsAutocomplete(this)}})};a.railsAutocomplete=function(a){_e=a;this.init(_e)};a.railsAutocomplete.fn=a.railsAutocomplete.prototype={railsAutocomplete:"0.0.1"};a.railsAutocomplete.fn.extend=a.railsAutocomplete.extend=a.extend;a.railsAutocomplete.fn.extend({init:function(a){function t(){o($(u+" ul.ui-menu li a"),true)}function s(a,b,c){return q($(a.get().reverse()),b,c)}function r(a,b,c){return q(a,b,c)}function q(a,b,c){var d,e=c==0;b&&o(a);a.each(function(b){d=b;if(b>=m(c,a.length)){return p($(this),a)}});return{current_index:d,iteration:e}}function p(c,d){if(c.attr("marked")=="true"){c.parent().removeClass("ui-menu-item-marked");b++}else{$(a).val(c.text());return n(c,true)}if(b==d.length)return o(d)}function o(c,e){!e&&$(a).val(i);d=0;b=0;c.each(function(a){n($(this),false)});return false}function n(a,b){var c=a.parent();klass="ui-menu-item-marked";b?c.addClass(klass):c.removeClass(klass);a.attr("marked",b);return false}function m(a,b){return a==0||b<a?0:b-a}function l(a){return k(a).pop().replace(/^\s+/,"")}function k(b){return b.split(a.delimiter)}var i=$(a).val();var j=$("<div></div>").attr("id",h+$(a).attr("id")).attr("input-source-id",$(a).attr("id"));$("body").append(j);a.delimiter=$(a).attr("data-delimiter")||null;var u="#"+h+$(a).attr("id");$(a).autocomplete({appendTo:u,open:function(a,b){t()},close:function(a,b){t()},source:function(b,c){$.getJSON($(a).attr("data-autocomplete"),{term:l(b.term)},function(){$(arguments[0]).each(function(b,c){var d={};d[c.id]=c;$(a).data(d)});c.apply(null,arguments)})},search:function(){var a=l(this.value);if(a.length<2){return false}},focus:function(){return false},select:function(b,c){var d=k(this.value);d.pop();d.push(c.item.value);if(a.delimiter!=null){d.push("");this.value=d.join(a.delimiter)}else{this.value=d.join("");if($(this).attr("data-id-element")){$($(this).attr("data-id-element")).val(c.item.id)}if($(this).attr("data-update-elements")){var e=$(this).data(c.item.id.toString());var f=$.parseJSON($(this).attr("data-update-elements"));for(var g in f){$(f[g]).val(e[g])}}}var h=this.value;$(this).bind("keyup.clearId",function(){if($(this).val().trim()!=h.trim()){$($(this).attr("data-id-element")).val("");$(this).unbind("keyup.clearId")}});$(this).trigger("railsAutocomplete.select",c);return false}});$(a).keydown(function(h){console.clear();var i=$.ui.keyCode,j=$(u+" ul.ui-menu li a");switch(h.keyCode){case i.PAGE_UP:break;case i.PAGE_DOWN:break;case i.UP:h.preventDefault();var k=c==i.DOWN;b=0;e=d;f=k?d:!g?f:0;item=s(j,k,f);d=item.current_index;if(d+1==j.length&&e==d){d=0;o(j)}g=item.iteration;d==0&&(g=true);c=i.UP;break;case i.DOWN:h.preventDefault();var k=c==i.UP;b=0;e=d;f=k?d:g?0:f;item=r(j,k,f);d=item.current_index;if(d+1==j.length&&e==d){d=0;o(j)}g=item.iteration;d==0&&(g=true);c=i.DOWN;break;case i.ENTER:case i.NUMPAD_ENTER:case i.TAB:h.preventDefault();$(a).autocomplete("close");break;case i.ESCAPE:break;default:break}});$(".ui-menu-item").live("click",function(b){b.preventDefault();var c=$(this);$(a).each(function(){if($(this).attr("id")==c.parent().parent().attr("input-source-id")){$(this).val(c.text());$(this).autocomplete("close")}})})}})})(jQuery)
